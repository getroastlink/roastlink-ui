<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RoastLink TWO Web Flasher</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="esptool.min.js"></script>
<style>
body { font-family: sans-serif; background:#111; color:#eee; text-align:center; padding:40px; }
button { font-size: 1.2em; padding:10px 25px; margin:10px; cursor:pointer; border-radius:8px; }
#log { text-align:left; background:#222; padding:15px; margin-top:20px; white-space:pre-line; border-radius:6px; }
</style>
</head>
<body>
<h1>ğŸ”¥ RoastLink TWO Web Flasher</h1>
<p>Flash firmware directly to your RoastLink device via USB-C.</p>
<button id="connect">Connect & Flash</button>
<div id="log">Waiting...</div>

<script>
const logBox = document.getElementById('log');
function log(msg) {
  console.log(msg);
  logBox.textContent += msg + "\n";
}

document.getElementById('connect').onclick = async () => {
  try {
    log("ğŸ”Œ Requesting device...");
    const port = await navigator.serial.requestPort();
    const transport = new Transport(port);
    await port.open({ baudRate: 921600 });
    log("âš™ï¸  Connecting to ESP32-S3...");

    const chip = new ESPTool(transport);
    await chip.initialize();
    const info = await chip.runStub();
    log(`âœ… Connected: ${info.chipName}, MAC: ${info.mac}`);

    const firmwareUrl = "https://ota.roastlink.com/two/roastlink-two-v0.9.3.bin";
    const resp = await fetch(firmwareUrl);
    const firmware = new Uint8Array(await resp.arrayBuffer());
    log(`â¬‡ï¸  Firmware loaded (${firmware.length} bytes)`);

    log("âš™ï¸ Erasing flash...");
    await chip.flashErase();

    log("âš¡ Flashing...");
    await chip.flashData(firmware, 0x10000, true); // true = compress

    log("âœ… Flash complete. Rebooting...");
    await chip.hardReset();
    log("ğŸ‰ Done! Device rebooting into new firmware.");

    await transport.disconnect();
  } catch (err) {
    log("âŒ Error: " + err.message);
    console.error(err);
  }
};
</script>
</body>
</html>
