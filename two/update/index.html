<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RoastLink TWO Web Flasher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; text-align:center; padding:40px; }
    button { font-size: 1.2em; padding:10px 25px; margin:10px; cursor:pointer; border-radius:8px; }
    #log { text-align:left; background:#222; padding:15px; margin-top:20px; white-space:pre-line; border-radius:6px; max-width:600px; margin-inline:auto; }
  </style>
</head>
<body>
  <h1>üî• RoastLink TWO Web Flasher</h1>
  <p>Flash firmware directly to your RoastLink device via USB-C.</p>
  <button id="connect">Connect & Flash</button>
  <div id="log">Waiting...</div>

  <script type="module">
    import { ESPLoader } from "https://unpkg.com/esptool-js@0.5.7/dist/web/index.min.js";

    const logBox = document.getElementById('log');
    const log = msg => { console.log(msg); logBox.textContent += msg + "\n"; };

    document.getElementById('connect').onclick = async () => {
      try {
        log("üîå Requesting device...");
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 921600 });

        log("‚öôÔ∏è Connecting to ESP32-S3...");
        const loader = new ESPLoader(port);
        await loader.initialize();
        const info = await loader.getChipInfo();
        log(`‚úÖ Connected: ${info.name}`);

        const firmwareUrl = "https://ota.roastlink.com/two/roastlink-two-v0.9.3.bin";
        const resp = await fetch(firmwareUrl);
        const firmware = new Uint8Array(await resp.arrayBuffer());
        log(`‚¨áÔ∏è Firmware loaded (${firmware.length} bytes)`);

        log("‚ö° Flashing...");
        await loader.flashData(firmware, 0x10000, true); // true = compress

        log("‚úÖ Flash complete. Rebooting...");
        await loader.hardReset();

        log("üéâ Done! Device rebooting into new firmware.");
        await port.close();
      } catch (err) {
        log("‚ùå Error: " + err.message);
        console.error(err);
      }
    };
  </script>
</body>
</html>
