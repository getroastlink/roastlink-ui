<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üî• RoastLink TWO Web Flasher</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0e0e0e;
    color: #eee;
    text-align: center;
    padding: 40px;
  }
  button {
    font-size: 1.1em;
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    margin: 12px;
    background: #ff7b00;
    color: #fff;
    cursor: pointer;
  }
  button:disabled {
    background: #444;
    cursor: not-allowed;
  }
  #log {
    text-align: left;
    background: #181818;
    color: #ccc;
    margin-top: 25px;
    padding: 15px;
    border-radius: 8px;
    max-width: 720px;
    margin-inline: auto;
    white-space: pre-line;
    font-family: ui-monospace, monospace;
  }
  select {
    font-size: 1em;
    padding: 8px;
    margin: 10px;
    border-radius: 6px;
  }
</style>
</head>
<body>
  <h1>üî• RoastLink TWO Web Flasher</h1>
  <p>Reflash your RoastLink TWO (ESP32-S3) directly in your browser.</p>

  <select id="firmware">
    <option value="https://ota.roastlink.com/two/roastlink-two-v0.9.4.bin">
      v0.9.4 (latest)
    </option>
  </select>
  <button id="flashBtn">Connect & Flash</button>

  <div id="log">Waiting...</div>

  <!-- ‚úÖ Make pako globally available -->
  <script type="module">
    import * as pako from "https://cdn.jsdelivr.net/npm/pako@2.1.0/+esm";
    window.pako = pako;
  </script>

  <!-- ‚úÖ Main flasher logic -->
  <script type="module">
    import { ESPLoader } from "./esploader.js";
    import { Transport } from "./webserial.js";
    import { getStubJsonByChipName } from "./stubFlasher.js";

    const logBox = document.getElementById("log");
    const flashBtn = document.getElementById("flashBtn");
    const log = (msg) => {
      console.log(msg);
      logBox.textContent += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    // Early browser support check
    if (!("serial" in navigator)) {
      document.body.innerHTML = `
        <h2 style="color:#ff5252;">‚ö†Ô∏è Web Serial not available</h2>
        <p>This page must be opened in <b>Google Chrome</b> or <b>Microsoft Edge</b><br>
        (and served over <b>HTTPS</b> or <b>localhost</b>).</p>`;
      throw new Error("Web Serial not supported");
    }

    flashBtn.onclick = async () => {
      try {
        flashBtn.disabled = true;
        const firmwareUrl = document.getElementById("firmware").value;
        log("üîå Requesting device access ‚Ä¶");
        const port = await navigator.serial.requestPort();
        const transport = new Transport(port);
        await port.open({ baudRate: 921600 });

        log("‚öôÔ∏è Connecting to ESP32-S3 ‚Ä¶");
        const loader = new ESPLoader(transport);
        await loader.initialize();

        // Try both modern and legacy chip info APIs
        let chipName = "ESP32-S3";
        try {
          chipName = loader.chip?.get_chip_description?.() ||
                     loader.getChipDescription?.() ||
                     "ESP32-S3";
        } catch {
          log("‚ö†Ô∏è Falling back to chip name default (ESP32-S3)");
        }
        log(`‚úÖ Connected to ${chipName}`);

        log("üì¶ Loading stub ‚Ä¶");
        const stub = await getStubJsonByChipName(chipName);
        await loader.loadStub(stub);
        log("üß† Stub loaded successfully");

        log(`‚¨áÔ∏è Downloading firmware from ${firmwareUrl} ‚Ä¶`);
        const resp = await fetch(firmwareUrl);
        const firmware = new Uint8Array(await resp.arrayBuffer());
        log(`Firmware size: ${firmware.length} bytes`);

        log("‚ö° Erasing flash ‚Ä¶");
        await loader.eraseFlash();

        log("üöÄ Flashing firmware ‚Ä¶");
        await loader.flashData(firmware, 0x10000, true);

        log("‚úÖ Flash complete ‚Äî rebooting device ‚Ä¶");
        await loader.hardReset();
        await port.close();

        log("üéâ Done! Your RoastLink TWO is now updated.");
      } catch (err) {
        console.error(err);
        log("‚ùå Error: " + err.message);
      } finally {
        flashBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
