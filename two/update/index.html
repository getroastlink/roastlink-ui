<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RoastLink TWO Web Flasher</title>
<style>
  body { font-family:sans-serif; background:#0e0e0e; color:#eee; text-align:center; padding:40px; }
  button { font-size:1.1em; padding:10px 20px; border:none; border-radius:8px; margin:10px;
           background:#ff7b00; color:#fff; cursor:pointer; }
  button:disabled { background:#555; cursor:not-allowed; }
  #log { text-align:left; background:#181818; color:#cfcfcf; margin-top:25px; padding:15px;
         border-radius:8px; max-width:700px; margin-inline:auto; white-space:pre-line; }
  select { font-size:1em; padding:8px; margin:10px; border-radius:6px; }
</style>
</head>
<body>
  <h1>üî• RoastLink TWO Web Flasher</h1>
  <p>Reflash your RoastLink TWO (ESP32-S3) directly in your browser.</p>

  <select id="firmware">
    <option value="roastlink-two-v0.9.4.bin">v0.9.4 (latest)</option>
  </select>
  <button id="flashBtn">Connect & Flash</button>
  <div id="log">Waiting...</div>

  <!-- Early serial check -->
  <script>
    if (!("serial" in navigator)) {
      document.body.innerHTML = `
        <h2 style="color:#ff5252;">‚ö†Ô∏è Web Serial not available</h2>
        <p>This page must be opened in <b>Google Chrome</b> or <b>Microsoft Edge</b><br>
        (and over <b>HTTPS</b> or <b>localhost</b>).</p>`;
    }
  </script>

  <script type="module">
    import { ESPLoader } from "https://cdn.jsdelivr.net/npm/esptool-js@0.5.7/dist/web/index.min.js";

    const logBox = document.getElementById("log");
    const flashBtn = document.getElementById("flashBtn");
    const log = msg => { console.log(msg); logBox.textContent += msg + "\n"; logBox.scrollTop = logBox.scrollHeight; };

    async function fetchStub() {
      const resp = await fetch("esp32s3.json");
      if (!resp.ok) throw new Error("Failed to load ESP32-S3 stub descriptor");
      return await resp.json();
    }

    flashBtn.onclick = async () => {
      try {
        const firmwareUrl = document.getElementById("firmware").value;
        log(`üîå Requesting device‚Ä¶`);
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 921600 });

        log("‚öôÔ∏è Connecting to ESP32-S3‚Ä¶");
        const loader = new ESPLoader(port);
        await loader.initialize();
        const info = await loader.getChipInfo();
        log(`‚úÖ Connected: ${info.name}`);

        log("üì¶ Uploading stub‚Ä¶");
        const stub = await fetchStub();
        await loader.loadStub(stub);
        log("üß† Stub loaded successfully");

        log(`‚¨áÔ∏è Downloading firmware from ${firmwareUrl}`);
        const resp = await fetch(firmwareUrl);
        const firmware = new Uint8Array(await resp.arrayBuffer());
        log(`Firmware size: ${firmware.length} bytes`);

        log("‚ö° Erasing flash‚Ä¶");
        await loader.eraseFlash();

        log("üöÄ Flashing firmware‚Ä¶");
        await loader.flashData(firmware, 0x10000, true);

        log("‚úÖ Flash complete. Rebooting‚Ä¶");
        await loader.hardReset();
        await port.close();

        log("üéâ Done! Your RoastLink TWO is now updated.");
      } catch (err) {
        console.error(err);
        log("‚ùå Error: " + err.message);
      }
    };
  </script>
</body>
</html>
